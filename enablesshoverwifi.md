# How to enable ssh over WiFi #

Either refer to: https://wiki.mobileread.com/wiki/Kindle4NTHacking#Jailbreak
or for some Kindle 4 Non Touch with software version 4.1.3 (the older ones) you do not need jailbreak, just follow:<br>
+ http://blog.joschika.tk/2012/03/01/kindle-4-nt-root-access/
+ http://blog.joschika.tk/2012/03/01/kindle-4nt-ssh-over-wifi/

However second point needs some corrections:

1. Switch to diagnostic mode, by adding an empty file "ENABLE_DIAGS" to usb root. Do not disconnect USB Cable
2. Restart from menu service menu and still on kindle:
3. In Diagnostic Mode go to
 * Misc individual diagnostics
 * Utilities
 * Enable USBnet and exit with the ->
4. On your linux terminal enable usbnetwork (check with ifconfig or dmesg new network device, for me it was enp0s20u6)
5. and follow the steps:
 * `sudo ifconfig enp0s20u6 192.168.15.2 netmask 255.255.255.0`
 * `ssh -oKexAlgorithms=+diffie-hellman-group1-sha1 root@192.168.15.244`
 * Login to kindle with a password generated by https://www.sven.de/kindle/ or your own if you have already changed and follow this steps
 * `mount /dev/mmcblk0p1 /mnt/base-mmc/`
 * add to `/mnt/base-mmc/etc/sysconfig/iptables`
       `-A INPUT -i wlan0 -p tcp --dport 22 -j ACCEPT` just before the final `COMMIT` Like this:

```bash
# ICMP. Allow only responses to local connections
-A INPUT -p icmp -m state --state RELATED,ESTABLISHED -j ACCEPT
# Kindle SSH rule
-A INPUT -i wlan0 -p tcp --dport 22 -j ACCEPT
COMMIT
```

 * Copy SSH host keys: `cp -a /etc/dropbear /mnt/base-mmc/etc`
 * Check if dropbear init file exists `/mnt/base-mmc/etc/init.d/dropbear`, if not create it with the content of:

```bash
#!/bin/sh                                                                       
                                                                                
_FUNCTIONS=/etc/rc.d/functions                                                  
[ -f ${_FUNCTIONS} ] && . ${_FUNCTIONS}                                         
                                                                                
case "$1" in                                                                    
start)                                                                          
                                                                                
   if [ -f "/etc/dropbear/authorized_keys" ]                                    
   then                                                                         
      mkdir /var/tmp/root/.ssh                                                  
      cp /etc/dropbear/authorized_keys /var/tmp/root/.ssh/                      
   fi                                                                           
                                                                                
   /usr/local/sbin/dropbear                                                     
   ;;                                                                           
                                                                                
*)                                                                              
   msg "usage: /etc/init.d/$NAME {start}" W >&2                                 
   exit 1                                                                       
   ;;                                                                           
                                                                                
esac                                                                            
                                                                                
exit 0 
```

 * Make it executable: `chmod 755 /mnt/base-mmc/etc/init.d/dropbear`
 * Start it in the 5th init level by: `ln -s /etc/init.d/dropbear /mnt/base-mmc/etc/rc5.d/S99dropbear`
 * `sync`, ` umount /mnt/base-mmc`and on kindle from main diagnostic menu go to Exit, Reboot or Disable Diags, disable Diag and confirmed with "<-" key.

Disconnect from USB, ssh over WiFi shall be ready.

### Password-Less ssh
For simple oeprations and quick login create password-less login:

1. ssh-keygen -t rsa (if not yet performed for other logins)
2. `ssh-copy-id root@kindle_ip` (where kindle_ip=ip of your kindle)
3. `ssh root@kindle_ip` (no more password needed)

*On Kindle:*
```bash
[root@kindle root]# mntroot rw
system: I mntroot:def:Making root filesystem writeable
/dev/mmcblk0p1 on / type ext3 (rw,noatime,nodiratime)
[root@kindle root]# cp .ssh/authorized_keys /etc/dropbear/authorized_keys
[root@kindle root]# mntroot ro
```
